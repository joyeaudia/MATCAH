// @ts-nocheck
!function(){"use strict";function e(e){return String(e||"").replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e])))}function t(e){const t=e.userId||"guest",n="orders_"+t;let d;try{d=JSON.parse(localStorage.getItem(n)||"[]")}catch(e){d=[]}Array.isArray(d)||(d=[]);const i=d.findIndex((t=>String(t.id)===String(e.id)));-1!==i?d[i]=e:d.unshift(e);try{localStorage.setItem(n,JSON.stringify(d))}catch(e){console.error("Failed to save order bucket for user",t,e)}}function n(e){const t="savedAddresses_v1_"+(e||"guest");let n=[];try{n=JSON.parse(localStorage.getItem(t)||"[]"),Array.isArray(n)||(n=[])}catch(e){n=[]}return n.length||(n=function(e,t){try{return JSON.parse(localStorage.getItem(e)||(t??"[]"))}catch(e){return t?JSON.parse(t):[]}}("savedAddresses_v1","[]")),n}function d(t){const d=document.getElementById("adm-order-id"),i=document.getElementById("adm-order-date"),a=document.getElementById("adm-status-text"),r=document.getElementById("adm-payment-badge"),c=document.getElementById("adm-total-badge"),o=document.getElementById("adm-items"),l=document.getElementById("adm-address-block");if(d&&(d.textContent=t.id||"(no id)"),i){const e=t.createdAt?new Date(t.createdAt):new Date;i.textContent=e.toLocaleString()}const s=(t.status||"active").toLowerCase();a&&(a.textContent=s);const m=(t.paymentStatus||"pending").toLowerCase();var u;if(r&&(r.textContent="Payment: "+m,r.classList.remove("paid","rejected"),"paid"===m&&r.classList.add("paid"),"rejected"===m&&r.classList.add("rejected")),c&&(c.textContent="Total: "+(u=t.total||0,"Rp "+new Intl.NumberFormat("id-ID").format(Number(u||0)))),o){const n=t.items&&t.items[0],d=Math.max(0,(t.items||[]).length-1);o.innerHTML=n?`<div>${e(n.title||"No title")}${d>0?" +"+d+" more":""}</div>`:"<div>No items</div>"}const g=n(t.userId);let y=null;if(Array.isArray(g)&&g.length&&(y=g.find((e=>e&&e.isDefault))||g[0]),l&&y){const t=e(y.label||""),n=e(y.name||""),d=e(y.phone||""),i=e(y.address||"").replace(/\n/g,"<br>"),a=`${t||""}${t&&n?" - ":""}${n||""}`;l.innerHTML=`\n        <div class="admin-address-title">Address</div>\n        <div class="admin-address-main">\n          <div>${a}</div>\n          ${d?`<div>${d}</div>`:""}\n          <div>${i}</div>\n        </div>\n      `}}document.addEventListener("DOMContentLoaded",(function(){const e=new URLSearchParams(window.location.search).get("id"),n=function(){const e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);if(!n||!n.startsWith("orders_"))continue;const d=n.slice(7)||"guest";let i;try{i=JSON.parse(localStorage.getItem(n)||"[]")}catch(e){i=[]}Array.isArray(i)&&i.forEach((t=>{t&&(t.userId||(t.userId=d),e.push(t))}))}return e}(),i=(n||[]).find((t=>String(t.id)===String(e)));if(!i)return alert("Order tidak ditemukan."),void(window.location.href="ordadm.html");d(i),function(e){const t=document.getElementById("adm-scheduled"),n=document.getElementById("adm-ship-fee"),d=document.getElementById("t-placed"),i=document.getElementById("t-payment"),a=document.getElementById("t-wait"),r=document.getElementById("t-prep"),c=document.getElementById("t-out-active"),o=document.getElementById("t-out-info"),l=e.tracking||{},s=(e.paymentStatus||"pending").toLowerCase();if(t)if(e.scheduledDelivery)t.value=e.scheduledDelivery;else if(e.scheduledAt)try{const n=new Date(e.scheduledAt);t.value=n.toISOString().slice(0,10)}catch(e){}n&&(n.value=null!=e.shippingFee?e.shippingFee:""),d&&(d.checked=null==l.placed||!!l.placed),i&&(i.checked=null!=l.paymentConfirmed?!!l.paymentConfirmed:"paid"===s),a&&(a.checked=!!l.waitingForSchedule),r&&(r.checked=!!l.preparingOrder);const m=l.outForDelivery||{};c&&(c.checked=!!m.active),o&&(o.value=m.info||"")}(i),function(e,n){const d=document.getElementById("adm-scheduled"),i=document.getElementById("adm-ship-fee"),a=document.getElementById("t-placed"),r=document.getElementById("t-payment"),c=document.getElementById("t-wait"),o=document.getElementById("t-prep"),l=document.getElementById("t-out-active"),s=document.getElementById("t-out-info"),m=document.getElementById("btn-save-tracking"),u=document.getElementById("btn-mark-delivered"),g=document.getElementById("btn-back-list");m&&m.addEventListener("click",(function(){if(d&&d.value?e.scheduledDelivery=d.value:delete e.scheduledDelivery,i){const t=Number(i.value||0);if(!isNaN(t))if(e.shippingFee=t,"number"==typeof e.subtotal)e.total=e.subtotal+t;else if(Array.isArray(e.items)){const n=e.items.reduce(((e,t)=>{const n=Number(t.qty||1),d=Number(t.unitPrice||t.price||0),i=null!=t.subtotal?Number(t.subtotal):n*d;return e+(isNaN(i)?0:i)}),0);e.total=n+t}}e.tracking={placed:!a||!!a.checked,paymentConfirmed:!!r&&!!r.checked,waitingForSchedule:!!c&&!!c.checked,preparingOrder:!!o&&!!o.checked,outForDelivery:{active:!!l&&!!l.checked,info:s?s.value.trim():""},delivered:!(!e.tracking||!e.tracking.delivered)};const m=n.findIndex((t=>String(t.id)===String(e.id)));-1!==m&&(n[m]=e),t(e),alert("Perubahan tracking & delivery berhasil disimpan.")})),u&&u.addEventListener("click",(function(){if(!confirm("Tandai order ini sebagai DELIVERED dan pindahkan ke History user?"))return;e.status="delivered",e.tracking=Object.assign({},e.tracking||{},{delivered:!0,deliveredAt:Date.now()});const d=n.findIndex((t=>String(t.id)===String(e.id)));-1!==d&&(n[d]=e),t(e),alert("Order telah ditandai sebagai DELIVERED."),window.location.href="ordadm.html"})),g&&g.addEventListener("click",(function(){window.location.href="ordadm.html"}))}(i,n)}))}();