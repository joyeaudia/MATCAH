// @ts-nocheck
!function(){"use strict";function e(e){return"Rp "+new Intl.NumberFormat("id-ID").format(Number(e||0))}function t(e){return String(e||"").replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e])))}function a(e){return`${e}_${localStorage.getItem("maziUID")||"guest"}`}function n(e,t){try{return JSON.parse(localStorage.getItem(e)||(t??"[]"))}catch(e){return t?JSON.parse(t):[]}}function r(){return n(a("orders"),"[]")}async function i(){const e=window.supabase;if(e)try{const{data:t,error:n}=await e.auth.getUser();if(n||!t?.user)return void console.warn("No Supabase user for orders, skip sync",n);const{data:i,error:s}=await e.from("orders").select("*, order_items(*)").eq("user_id",t.user.id).order("created_at",{ascending:!1});if(s)return void console.warn("Supabase orders fetch error:",s);const d=(i||[]).map((e=>{const t=Array.isArray(e.order_items)?e.order_items.map((e=>({id:e.product_id||null,title:e.title,qty:e.qty,unitPrice:e.unit_price,subtotal:e.subtotal,image:e.image_url||"",addons:e.addons_json||[]}))):[];return{id:e.client_order_id||`DB-${e.id}`,createdAt:e.created_at?Date.parse(e.created_at):Date.now(),status:e.status||"active",scheduledAt:e.scheduled_at||null,total:e.total||0,shippingFee:e.shipping_fee||0,paymentStatus:e.payment_status||"pending",isGift:!!e.is_gift,items:t,meta:{notes:e.notes||"",recipient:e.recipient_name||"",deliveryMethod:e.delivery_method||null},gift:e.is_gift?{message:e.gift_message||"",fromName:e.gift_from_name||"",revealMode:e.gift_reveal_mode||"reveal",theme:e.gift_theme||null}:null}})),o=r()||[],c=new Map;o.forEach((e=>{e&&e.id&&c.set(String(e.id),e)})),d.forEach((e=>{e&&e.id&&c.set(String(e.id),e)}));const l=Array.from(c.values());!function(e){try{const t=a("orders");localStorage.setItem(t,JSON.stringify(e||[]))}catch(e){console.error("Failed to save orders",e)}}(l),console.log("Orders synced from Supabase:",l.length)}catch(e){console.warn("syncOrdersFromSupabase error:",e)}else console.warn("Supabase client not found on window, skip sync")}function s(e,n){const i="history"===(n&&n.context||""),s=e.items&&e.items[0],o=Math.max(0,(e.items||[]).length-1),c=s?function(e){const t=String(e?.id||"").toLowerCase(),a=String(e?.title||"").toLowerCase();return t.startsWith("dsri")||t.startsWith("dessert")||a.includes("dessert")?"Desserts":t.startsWith("drsi")||t.startsWith("drink")||a.includes("latte")||a.includes("drink")?"Drinks":"Products"}(s):"Products",l='<img src="'+t(s&&(s.image||s.images&&s.images[0])||"assets/placeholder.png")+'" alt="'+t(s?s.title:"Product")+'" style="width:68px;height:68px;object-fit:cover;border-radius:8px">',u=e.status||"active",m=String(u).toLowerCase(),g=new Date(e.createdAt||Date.now()).toLocaleString();let p="";if(i&&"cancelled"===m)p='  <div class="order-actions">    <button class="btn-outline reorder-btn" data-order-id="'+t(e.id)+'">Reorder</button>    <button class="btn-light view-details" data-order-id="'+t(e.id)+'">View Details</button>  </div>';else{const a=i?"Reorder":"View Details",n=i?"reorder-btn":"view-details";p='  <div class="order-actions">    <button class="btn-outline track-btn" data-order-id="'+t(e.id)+'">Track Order</button>    <button class="btn-light '+n+'" data-order-id="'+t(e.id)+'">'+a+"</button>  </div>"}const h=document.createElement("article");return h.className="order-card",h.innerHTML='<div class="thumb">'+l+'</div><div class="order-info">  <div class="order-top">    <h3 class="product-title">'+t(s?s.title:"No title")+'</h3>    <span class="more">'+(o>0?"+"+o+" More":"")+'</span>  </div>  <p class="brand">'+t(c)+'</p>  <div class="status-row">    <span class="status">Status : <strong>'+t(u)+'</strong></span>    <span class="eta">Created : <em>'+t(g)+"</em></span>  </div>"+p+"</div>",h.querySelectorAll(".view-details").forEach((e=>{e.addEventListener("click",(function(){d(this.dataset.orderId)}))})),h.querySelectorAll(".reorder-btn").forEach((e=>{e.addEventListener("click",(function(){const e=this.dataset.orderId;e&&function(e){const t=(r()||[]).find((t=>String(t.id)===String(e)));if(!t)return void alert("Order tidak ditemukan.");let n=function(){try{const e=a("cart");return JSON.parse(localStorage.getItem(e)||"[]")}catch(e){return[]}}()||[];(t.items||[]).forEach(((e,a)=>{if(!e)return;const r=Number(e.qty||1),i=Number(e.unitPrice||e.price||0),s=Number(e.subtotal||i*r),d={id:e.id||`reorder-${t.id}-${a}`,title:e.title||"",unitPrice:i,qty:r,subtotal:s,image:e.image||e.images&&e.images[0]||"assets/placeholder.png",addons:e.addons||[],source:"reorder"};n.push(d)})),function(e){try{const t=a("cart");localStorage.setItem(t,JSON.stringify(e||[]))}catch(e){console.error("Failed to save bag items",e)}}(n),alert("Barang dari order ini sudah dimasukkan ke Bag ‚úî"),window.location.href="bagfr.html"}(e)}))})),h.querySelectorAll(".track-btn").forEach((e=>{e.addEventListener("click",(function(){const e=this.dataset.orderId;e&&(window.location.href="ditel.html?id="+encodeURIComponent(e))}))})),h}function d(i){const s=(r()||[]).find((e=>String(e.id)===String(i))),d=["tab-active","tab-schedule","tab-scheduled","tab-history"];let o=null;for(const e of d){const t=document.getElementById(e);if(!t)continue;const a="none"===t.style.display,n=t.classList.contains("hidden");if(!a&&!n){o=t;break}}if(o||(o=document.getElementById("tab-history")||document.getElementById("tab-active")),!o)return;if(o.innerHTML="",!s)return void(o.innerHTML='<div style="padding:12px;color:#c33">Order tidak ditemukan.</div>');const l=document.createElement("h2");l.textContent="Order Details",o.appendChild(l);const u=document.createElement("div");if(u.style.marginTop="12px",(s.items||[]).forEach((a=>{const n=document.createElement("div");n.style.padding="10px 0",n.innerHTML='<div style="display:flex;gap:12px;align-items:center">  <div style="width:56px;height:56px;border-radius:8px;overflow:hidden;background:#f5f5f7;flex:0 0 56px">'+(a.image?'<img src="'+t(a.image)+'" style="width:100%;height:100%;object-fit:cover">':"")+'  </div>  <div style="flex:1">    <div style="font-weight:700">'+t(a.title)+"</div>"+(a.addons&&a.addons.length?'<div style="color:#666;margin-top:6px">'+a.addons.map((e=>t(e.label))).join(", ")+"</div>":"")+'    <div style="color:#666;margin-top:6px">'+(a.qty||0)+" √ó "+e(a.unitPrice)+" = "+e(a.subtotal)+"</div>  </div></div>",u.appendChild(n)})),o.appendChild(u),s.isGift&&s.gift){const e=document.createElement("div");e.className="order-gift-block",e.style.marginTop="12px",e.style.padding="12px",e.style.borderRadius="10px",e.style.background="#fff6fb";const a="surprise"===String(s.gift.revealMode||"reveal")?"Keep it a surprise":"Reveal it now";let n="";if(s.scheduledAt)try{n="<div><strong>Schedule:</strong> "+t(new Date(s.scheduledAt).toLocaleString("id-ID"))+"</div>"}catch(e){}const r=s.gift.message?"<div><strong>Message:</strong> "+t(s.gift.message)+"</div>":"",i=s.gift.fromName?"<div><strong>From:</strong> "+t(s.gift.fromName)+"</div>":"",d=s.gift.theme?"<div><strong>Card theme:</strong> "+t(s.gift.theme)+"</div>":"";e.innerHTML='<div style="font-weight:600;margin-bottom:4px">üéÅ Gift details</div>'+r+i+"<div><strong>Reveal:</strong> "+t(a)+"</div>"+d+n,o.appendChild(e)}const m=s.meta&&"string"==typeof s.meta.recipient?s.meta.recipient.trim():"";if(m){const e=document.createElement("div");e.className="order-address-block";const a=t(m).replace(/\n/g,"<br>");e.innerHTML=`\n        <div class="order-address-head">\n          <span class="title">Recipient</span>\n        </div>\n        <div class="order-address-body">\n          <div class="line-address">${a}</div>\n        </div>\n      `,o.appendChild(e)}else{const e=n(a("savedAddresses_v1"),"[]");let r=null;if(Array.isArray(e)&&e.length&&(r=e.find((e=>e&&e.isDefault))||e[0]),r){const e=document.createElement("div");e.className="order-address-block";const a=t(r.label||""),n=t(r.name||""),i=t(r.phone||""),s=t(r.address||"").replace(/\n/g,"<br>"),d=`${a||""}${a&&n?" - ":""}${n||""}`;e.innerHTML=`\n          <div class="order-address-head">\n            <span class="title">Address</span>\n            <a href="drafamt.html" class="edit-link small">Edit</a>\n          </div>\n          <div class="order-address-body">\n            <div class="line-combined">${d}</div>\n            ${i?`<div class="line-phone">${i}</div>`:""}\n            <div class="line-address">${s}</div>\n          </div>\n        `,o.appendChild(e)}}const g=(s.paymentStatus||"pending").toLowerCase(),p=(s.status||"").toLowerCase(),h="paid"===g,v="rejected"===g||"cancelled"===p,f=document.createElement("div");let b="pending",y="";h?(b="paid",y="<div>Status pesanan: <strong>Pesanan "+t(s.id||"")+' sudah dibayar.</strong></div><div class="status">Pembayaran sudah diterima admin ‚úÖ</div><div class="track-hint">Anda dapat men-track order Anda dari halaman Orders / Active.</div>'):v?f.innerHTML='<div style="font-weight:600">‚õî Orderan ini dicancel oleh admin</div><div class="status">Status pembayaran: <strong style="color:#c00">Ditolak admin</strong></div><div class="track-hint" style="color:#c00">Silakan hubungi admin jika ada kesalahan.</div>':(b="pending",y='<div>Segera melakukan pembayaran melalui WhatsApp kepada toko agar orderan Anda dapat di-ACC.</div><div class="status">Status pembayaran: <strong>Pembayaran belum diterima admin</strong></div>'),v||(f.className="order-payment-note "+b,f.innerHTML=y),o.appendChild(f);const w=document.createElement("div");w.style.marginTop="12px",w.style.fontWeight="700",w.textContent="Total: "+e(s.total),o.appendChild(w);const S=document.createElement("div");S.style.marginTop="12px",S.innerHTML='<button class="btn-light" id="back-to-summary">Back to summary</button>',o.appendChild(S);const k=S.querySelector("#back-to-summary");k&&k.addEventListener("click",(function(){c()}))}function o(){const e=document.getElementById("notif-badge");if(!e)return;const t=n(a("notifications_v1"),"[]");Array.isArray(t)&&t.some((e=>!e.isRead))?e.classList.add("show"):e.classList.remove("show")}function c(){!function(){const e=document.getElementById("tab-active");if(!e)return;e.innerHTML="";const t=r()||[];if(!t.length)return void(e.innerHTML='<div style="padding:16px;color:#666">Belum ada pesanan.</div>');let a=t.filter((e=>"active"===String(e.status||"").toLowerCase()));a.length||(a=t.filter((e=>!e.status))),a.length?a.forEach((t=>{e.appendChild(s(t,{context:"active"}))})):e.innerHTML='<div style="padding:16px;color:#666">Tidak ada pesanan aktif saat ini.</div>'}(),function(){const e=document.getElementById("tab-schedule")||document.getElementById("tab-scheduled");if(!e)return;e.innerHTML="";const t=(r()||[]).filter((e=>{const t=String(e.status||"").toLowerCase();return!["delivered","completed","cancelled"].includes(t)&&("scheduled"===t||e.scheduledAt)}));t.length?t.forEach((t=>{e.appendChild(s(t,{context:"scheduled"}))})):e.innerHTML='<div style="padding:16px;color:#666">No scheduled orders.</div>'}(),function(){const e=document.getElementById("tab-history");if(!e)return;e.innerHTML="";const t=(r()||[]).filter((e=>{const t=String(e.status||"").toLowerCase();return["delivered","completed","cancelled"].includes(t)}));t.length?t.forEach((t=>{e.appendChild(s(t,{context:"history"}))})):e.innerHTML='<div style="padding:16px;color:#666">History kosong.</div>'}()}document.addEventListener("DOMContentLoaded",(function(){try{c(),document.querySelectorAll("[data-order-tab],[data-tab]").forEach((e=>{e.addEventListener("click",(function(){const e=this.dataset.orderTab||this.dataset.tab;if(!e)return;localStorage.setItem("lastOrderTab",e);const t={active:"tab-active",scheduled:"tab-scheduled",schedule:"tab-schedule",history:"tab-history"}[e]||e;["tab-active","tab-scheduled","tab-schedule","tab-history"].forEach((e=>{const a=document.getElementById(e);if(!a)return;const n=e===t;a.style.display=n?"":"none",a.classList.toggle("hidden",!n)})),document.querySelectorAll("[data-order-tab],[data-tab]").forEach((t=>{const a=(t.dataset.orderTab||t.dataset.tab)===e;t.classList.toggle("tab-active",a),t.setAttribute("aria-selected",a?"true":"false")}))}))}));const e=new URLSearchParams(window.location.search).get("tab"),t=localStorage.getItem("lastOrderTab"),a=e||t||"active",n=document.querySelector(`[data-order-tab="${a}"], [data-tab="${a}"]`);n&&n.click(),o(),window.addEventListener("storage",(function(e){e.key&&e.key.startsWith("notifications_v1_")&&o()})),i().then((()=>{c()}))}catch(e){console.error("order render error",e)}})),window.renderAllOrders=c,window.renderOrderDetails=d,window.updateNotifBadge=o}();