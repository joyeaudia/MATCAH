// @ts-nocheck
document.addEventListener("DOMContentLoaded",(function(){"use strict";const e=window.supabase||null,t=e=>{const t=Math.round(Number(e)||0),n=Math.abs(t).toString(),a=[];for(let e=n.length-1,t=0;e>=0;e--,t++)a.push(n[e]),t%3==2&&0!==e&&a.push(".");return(t<0?"-":"")+"Rp "+a.reverse().join("")+",00"};function n(e){return`${e}_${localStorage.getItem("maziUID")||"guest"}`}function a(e){try{return JSON.parse(localStorage.getItem(e)||"[]")}catch(e){return[]}}function r(e,t){localStorage.setItem(e,JSON.stringify(t||[]))}function o(){return a(n("cart"))}function i(e){return String(e||"").replace(/[&<>"']/g,(function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]}))}const c=document.querySelector(".product-list"),l=document.getElementById("subtotalRp"),s=document.getElementById("shippingFee"),d=document.getElementById("totalRp"),u=Array.from(document.querySelectorAll(".delivery-item")),m=(document.getElementById("deliveryRow"),document.getElementById("btnUseSavedAddress"));m&&m.addEventListener("click",(function(){window.location.href="drafamt.html?from=checkout"}));const p=document.getElementById("recipient");try{const e=localStorage.getItem("checkoutRecipientDraft_v1");p&&e&&(p.value=e,localStorage.removeItem("checkoutRecipientDraft_v1"))}catch(e){}if(!(c&&l&&s&&d))return void console.warn("cekout: required elements not found");function g(){const e=o();if(c.innerHTML="",!e||!e.length){const e=document.createElement("li");return e.className="product-item",e.innerHTML='<div class="product-info"><div class="product-title">Keranjang kosong</div><div class="product-meta muted">Tambahkan produk dari keranjang</div></div>',c.appendChild(e),void v()}e.forEach(((e,n)=>{const a=Number(e.unitPrice||e.price||0),r=Math.max(0,Number(e.qty||1)),o=document.createElement("li");o.className="product-item",o.dataset.cartIdx=n;const l=e.source?`${e.source} • `:"",s=t(a);o.innerHTML=`\n        <div class="product-info">\n          <div class="product-title">${i(e.title||"Untitled")}</div>\n          <div class="product-meta">${i(l)}${s}</div>\n        </div>\n        <div class="qty-control" data-price="${a}">\n          <button class="qty-btn dec" aria-label="Decrease">−</button>\n          <input class="qty-input" type="text" inputmode="numeric" value="${r}" aria-label="Quantity">\n          <button class="qty-btn inc" aria-label="Increase">+</button>\n        </div>\n      `,c.appendChild(o);const d=o.querySelector(".dec"),u=o.querySelector(".inc"),m=o.querySelector(".qty-input");d.addEventListener("click",(()=>{let e=Number(m.value)||0;e=Math.max(0,e-1),m.value=String(e),h(n,e)})),u.addEventListener("click",(()=>{let e=Number(m.value)||0;e+=1,m.value=String(e),h(n,e)})),m.addEventListener("input",(()=>{m.value=m.value.replace(/[^\d]/g,""),""===m.value&&(m.value="0");const e=Number(m.value);h(n,e)}))}))}function h(e,t){const a=o();var i;a&&a[e]?(a[e].qty=Number(t||0),a[e].subtotal=Number(a[e].unitPrice||a[e].price||0)*Number(a[e].qty||0),a[e].qty<=0&&a.splice(e,1),i=a,r(n("cart"),i),g(),v()):v()}function v(){const e=o();let n=0,a=0;Array.isArray(e)&&e.forEach((e=>{const t=Number(e.unitPrice||e.price||0),r=Math.max(0,Number(e.qty||0));a+=t*r,n+=r}));let r=15e3;switch(document.querySelector(".delivery-item.active")?.dataset.method||"regular"){case"regular":default:r=15e3;break;case"nextday":r=2e4;break;case"sameday":r=3e4;break;case"instant":r=5e4;break;case"self":r=5e3}const i=r*(n>0?Math.max(1,Math.ceil(n/5)):1),c=a+i;l&&(l.textContent=t(a)),s&&(s.textContent=t(i)),d&&(d.textContent=t(c))}u.forEach((e=>{e.addEventListener("click",(()=>{u.forEach((e=>{e.classList.remove("active"),e.setAttribute("aria-pressed","false")})),e.classList.add("active"),e.setAttribute("aria-pressed","true"),"function"==typeof e.scrollIntoView&&e.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"}),v()}))}));const y=document.getElementById("placeOrder");y&&y.addEventListener("click",(async function(){const t=o();if(!t||!t.length)return void alert("Keranjang kosong — tidak ada yang dipesan.");let i=null;try{const e=document.querySelector('select[aria-label="Date"]'),t=document.querySelector('select[aria-label="Month"]'),n=document.querySelector('select[aria-label="Year"]'),a=e?.value||"",r=t?.value||"",o=n?.value||"",c=Number(a),l=Number(o);if(!isNaN(c)&&!isNaN(l)&&r){const e={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};let t=Number(r);if(isNaN(t)){t=e[String(r).trim().slice(0,3).toLowerCase()]||NaN}if(!isNaN(t)){const e=new Date(l,t-1,c,9,0,0);isNaN(e.getTime())||(i=e.toISOString())}}}catch(e){}const c=document.getElementById("notes")?.value?.trim()||"",l=document.getElementById("recipient")?.value?.trim()||"";let s=0;t.forEach((e=>{s+=Number(e.subtotal||Number(e.unitPrice||e.price||0)*Number(e.qty||0)||0)}));const d=document.querySelector(".delivery-item.active")?.dataset.method||"regular";let u=15e3;switch(d){case"regular":default:u=15e3;break;case"nextday":u=2e4;break;case"sameday":u=3e4;break;case"instant":u=5e4;break;case"self":u=5e3}const m=t.reduce(((e,t)=>e+Number(t.qty||0)),0),p=u*Math.max(1,Math.ceil(m/5)),g=Number(s)+Number(p);let h=null;try{h=JSON.parse(localStorage.getItem("giftConfig_v1")||"null")}catch(e){h=null}const v=!(!h||"gift"!==h.type),y={id:"ORD-"+(new Date).toISOString().slice(0,10)+"-"+Math.random().toString(36).slice(2,6).toUpperCase(),createdAt:Date.now(),status:"scheduled",scheduledAt:i,total:g,shippingFee:p,items:t.map((e=>({id:e.id,title:e.title,qty:Number(e.qty||1),unitPrice:Number(e.unitPrice||e.price||0),subtotal:Number(e.subtotal||Number(e.unitPrice||e.price||0)*Number(e.qty||1)),addons:e.addons||[],image:e.image||e.images&&e.images[0]||""}))),meta:{notes:c,recipient:l,deliveryMethod:d},paymentStatus:"pending"};if(v&&(y.isGift=!0,y.gift={message:h.message||"",fromName:h.fromName||"",revealMode:h.revealMode||"reveal",theme:h.theme||null}),e)try{const{data:t,error:n}=await e.auth.getUser();if(!n&&t?.user){const n=t.user,{data:a,error:r}=await e.from("orders").insert({user_id:n.id,client_order_id:y.id,status:y.status,is_gift:!!y.isGift,scheduled_at:y.scheduledAt||null,total:y.total,shipping_fee:y.shippingFee,payment_status:y.paymentStatus,delivery_method:d,notes:c||null,recipient_name:null,recipient_phone:null,recipient_address:l||null}).select("id").single();if(r)console.warn("Supabase orders insert error:",r);else if(a){const t=y.items.map((e=>({order_id:a.id,product_id:e.id?String(e.id):null,title:e.title,qty:e.qty,unit_price:e.unitPrice,subtotal:e.subtotal,image_url:e.image||null,addons_json:e.addons&&e.addons.length?e.addons:null}))),{error:n}=await e.from("order_items").insert(t);n&&console.warn("Supabase order_items insert error:",n)}}else console.warn("Supabase getUser error / no user, skip remote order save",n)}catch(e){console.warn("Unexpected Supabase error during checkout:",e)}const b=a(n("orders"));var f;b.unshift(y),f=b,r(n("orders"),f);try{localStorage.removeItem(n("cart"))}catch(e){}try{localStorage.removeItem("giftConfig_v1")}catch(e){}try{const e="628118281416";let t="";if(v){const e=i?new Date(i).toLocaleString("id-ID"):"(tanpa jadwal)";t=`Halo mimin Mazi, ini pesanan GIFT terjadwal dengan ID ${y.id}. Mohon dibantu proses untuk jadwal ${e}.`}else t=`Halo mimin Mazi, tolong proses pesanan terjadwal saya dengan ID ${y.id}.`;const n=`https://wa.me/${e}?text=${encodeURIComponent(t)}`,a=document.getElementById("ddno-overlay"),r=document.getElementById("ddno-logo");a&&a.classList.add("show"),r&&(r.classList.remove("show"),setTimeout((()=>{r.classList.add("show")}),50)),setTimeout((()=>{try{window.open(n,"_blank")}catch(e){console.warn("Failed to open WhatsApp",e)}window.location.href="./order.html?order="+encodeURIComponent(y.id)}),1500)}catch(e){console.warn("Failed to prepare WhatsApp redirect",e),window.location.href="./order.html?order="+encodeURIComponent(y.id)}})),function({yearsAhead:e=5}={}){const t=document.querySelector('select[aria-label="Date"]'),n=document.querySelector('select[aria-label="Month"]'),a=document.querySelector('select[aria-label="Year"]');if(!t||!n||!a)return;function r(e,t){const n=document.createElement("option");return n.value=String(e),n.textContent=String(t),n}t.innerHTML="",n.innerHTML="",a.innerHTML="";const o=new Date,i=o.getFullYear();n.appendChild(r("","Month")),["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].forEach(((e,t)=>n.appendChild(r(t+1,e)))),a.appendChild(r("","Year"));for(let t=i;t<=i+(Number(e)||5);t++)a.appendChild(r(t,t));function c(){const e=Number(n.value)||o.getMonth()+1,c=Number(a.value)||i,l=function(e,t){return new Date(e,t+1,0).getDate()}(c,e-1),s=Number(t.value)||o.getDate();t.innerHTML="",t.appendChild(r("","Date"));for(let e=1;e<=l;e++)t.appendChild(r(e,e));s>=1&&s<=l?t.value=String(s):c===i&&e===o.getMonth()+1?t.value=String(o.getDate()):t.value="1"}n.value=String(o.getMonth()+1),a.value=String(i),c(),n.addEventListener("change",c),a.addEventListener("change",c)}({yearsAhead:5}),g(),v()}));